#!/bin/bash
# Pre-removal script for Linux Download Manager (LDM)
# This script is executed before the package is removed
# Developed by: Anna-el Gerard RABENANDRASANA (aerab243)
# Project: https://github.com/aerab243/ldm

set -e

# Package name
PACKAGE_NAME="ldm"

case "$1" in
    remove|upgrade|deconfigure)
        echo "Preparing to remove Linux Download Manager..."

        # Stop any running LDM processes
        if command -v killall >/dev/null 2>&1; then
            killall ldm 2>/dev/null || true
            killall ldm-native-host 2>/dev/null || true
        fi

        # Give processes time to shutdown gracefully
        sleep 2

        # Force kill if still running
        if command -v pkill >/dev/null 2>&1; then
            pkill -f "ldm" 2>/dev/null || true
            pkill -f "ldm-native-host" 2>/dev/null || true
        fi

        # Remove native messaging hosts
        if [ -f "/etc/opt/chrome/native-messaging-hosts/ldm-chrome.json" ]; then
            rm -f /etc/opt/chrome/native-messaging-hosts/ldm-chrome.json || true
        fi

        if [ -f "/usr/lib/mozilla/native-messaging-hosts/ldm-firefox.json" ]; then
            rm -f /usr/lib/mozilla/native-messaging-hosts/ldm-firefox.json || true
        fi

        # Unregister URL handlers
        if command -v xdg-mime >/dev/null 2>&1; then
            # Note: We can't easily restore the previous default handler
            # so we just remove our association
            echo "Note: URL handler associations will be reset"
        fi

        # Remove symlink
        if [ -L "/usr/local/bin/ldm" ]; then
            rm -f /usr/local/bin/ldm || true
        fi

        ;;

    failed-upgrade)
        # Nothing to do
        ;;

    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
