#!/bin/bash
# Post-installation script for Linux Download Manager (LDM)
# This script is executed after the package is installed
# Developed by: Anna-el Gerard RABENANDRASANA (aerab243)
# Project: https://github.com/aerab243/ldm

set -e

# Package name
PACKAGE_NAME="ldm"

# Application directories
APP_DIR="/usr/bin"
SHARE_DIR="/usr/share/ldm"
DOC_DIR="/usr/share/doc/ldm"
DESKTOP_DIR="/usr/share/applications"
ICON_DIR="/usr/share/icons/hicolor"

# User directories
XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"

case "$1" in
    configure)
        echo "Configuring Linux Download Manager..."

        # Update desktop database
        if command -v update-desktop-database >/dev/null 2>&1; then
            update-desktop-database -q /usr/share/applications || true
        fi

        # Update icon cache
        if command -v gtk-update-icon-cache >/dev/null 2>&1; then
            gtk-update-icon-cache -q -t -f /usr/share/icons/hicolor || true
        fi

        # Update MIME database
        if command -v update-mime-database >/dev/null 2>&1; then
            update-mime-database /usr/share/mime || true
        fi

        # Create system-wide configuration directory
        if [ ! -d "/etc/ldm" ]; then
            mkdir -p /etc/ldm
            chmod 755 /etc/ldm
        fi

        # Create default configuration if it doesn't exist
        if [ ! -f "/etc/ldm/ldm.conf" ]; then
            cat > /etc/ldm/ldm.conf << 'EOF'
# Linux Download Manager System Configuration
# This file contains system-wide settings for Linux Download Manager
# Developed by: Anna-el Gerard RABENANDRASANA
# Project: https://github.com/aerab243/ldm

[General]
# Default download directory (relative to user's home)
DefaultDownloadDir=Downloads/LDM

# Maximum concurrent downloads
MaxConcurrentDownloads=3

# Default connection timeout (seconds)
ConnectionTimeout=30

# Enable virus scanning (requires ClamAV)
VirusScanEnabled=false

[Network]
# User agent string
UserAgent=Linux Download Manager/1.0.0 (https://github.com/aerab243/ldm)

# Enable proxy support
ProxyEnabled=false

# Maximum bandwidth per download (KB/s, 0 = unlimited)
MaxBandwidthPerDownload=0

[Security]
# Allow downloads from HTTPS only
HTTPSOnly=false

# Verify SSL certificates
VerifySSL=true

# Maximum file size (MB, 0 = unlimited)
MaxFileSize=0
EOF
            chmod 644 /etc/ldm/ldm.conf
        fi

        # Set up log directory
        if [ ! -d "/var/log/ldm" ]; then
            mkdir -p /var/log/ldm
            chmod 755 /var/log/ldm
        fi

        # Create native messaging host directory for browser integration
        NATIVE_MESSAGING_DIR="/etc/opt/chrome/native-messaging-hosts"
        if [ ! -d "$NATIVE_MESSAGING_DIR" ]; then
            mkdir -p "$NATIVE_MESSAGING_DIR"
        fi

        # Install Chrome/Chromium native messaging manifest
        if [ -f "/usr/share/ldm/native-messaging/ldm-chrome.json" ]; then
            cp "/usr/share/ldm/native-messaging/ldm-chrome.json" "$NATIVE_MESSAGING_DIR/"
            chmod 644 "$NATIVE_MESSAGING_DIR/ldm-chrome.json"
        fi

        # Install Firefox native messaging manifest
        FIREFOX_NATIVE_DIR="/usr/lib/mozilla/native-messaging-hosts"
        if [ ! -d "$FIREFOX_NATIVE_DIR" ]; then
            mkdir -p "$FIREFOX_NATIVE_DIR"
        fi

        if [ -f "/usr/share/ldm/native-messaging/ldm-firefox.json" ]; then
            cp "/usr/share/ldm/native-messaging/ldm-firefox.json" "$FIREFOX_NATIVE_DIR/"
            chmod 644 "$FIREFOX_NATIVE_DIR/ldm-firefox.json"
        fi

        # Register URL handlers for download protocols
        if command -v xdg-mime >/dev/null 2>&1; then
            # Register as default handler for magnet links
            xdg-mime default ldm.desktop x-scheme-handler/magnet || true

            # Register for metalink files
            xdg-mime default ldm.desktop application/metalink+xml || true
            xdg-mime default ldm.desktop application/metalink4+xml || true
        fi

        # Add LDM to system PATH if not already there
        if ! echo "$PATH" | grep -q "/usr/bin"; then
            # This is usually already in PATH, but just in case
            echo "Note: Make sure /usr/bin is in your PATH"
        fi

        # Set proper permissions for executable
        if [ -f "/usr/bin/ldm" ]; then
            chmod 755 /usr/bin/ldm
        fi

        # Set proper permissions for native messaging host
        if [ -f "/usr/bin/ldm-native-host" ]; then
            chmod 755 /usr/bin/ldm-native-host
        fi

        # Create symlink for compatibility
        if [ ! -L "/usr/local/bin/ldm" ] && [ -f "/usr/bin/ldm" ]; then
            ln -sf /usr/bin/ldm /usr/local/bin/ldm || true
        fi

        # Print installation success message
        echo ""
        echo "Linux Download Manager has been successfully installed!"
        echo ""
        echo "To start Linux Download Manager:"
        echo "  - From GUI: Look for 'Linux Download Manager' in your applications menu"
        echo "  - From terminal: run 'ldm'"
        echo ""
        echo "Browser integration:"
        echo "  - Chrome/Chromium: Install the Linux Download Manager browser extension"
        echo "  - Firefox: Install the Linux Download Manager browser extension"
        echo ""
        echo "Configuration files:"
        echo "  - System: /etc/ldm/ldm.conf"
        echo "  - User: ~/.config/ldm/config.ini"
        echo ""
        echo "Developer: Anna-el Gerard RABENANDRASANA (aerab243)"
        echo "Contact: aerabenandrasana@gmail.com"
        echo "Project: https://github.com/aerab243/ldm"
        echo "For more information and support, visit the project page above."
        echo ""

        ;;

    abort-upgrade|abort-remove|abort-deconfigure)
        # Nothing to do
        ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
